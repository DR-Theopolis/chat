<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
</head>
<body>
    <iframe class="storeMsg" frameborder="10" style="width:100%; height: 100%;"></iframe>
    <div>
        <p>Please don't upload files that can't be rendered by a browser.</p>
        <input type="file" onchange="encodeImageFileAsURL(this)" />
    </div>
    <br>
    <br>
    <textarea class="msgBox" cols="30" rows="10"></textarea>
    <button class="sendMsg">Send</button>
    <script src="http://dylan.local:3000/socket.io/socket.io.js"></script>
    <script>
        var connectionOptions =  {
        "force new connection" : true,
        "reconnectionAttempts": "Infinity", //avoid having user reconnect manually in order to prevent dead clients after a server restart
        "timeout" : 10000,                  //before connect_error and connect_timeout are emitted.
        "transports" : ["websocket"]
    };

    var socket = io('http://dylan.local:3000', connectionOptions);
    const msgBox = document.querySelector("textarea.msgBox");
    const sendMsg = document.querySelector("button.sendMsg");
    const storeMsg = document.querySelector("iframe.storeMsg");
    function getUsername () {
        if (localStorage.hasOwnProperty('username')) {
            return localStorage.getItem('username');
        } else {
            const user = prompt('Please enter a username');
            localStorage.setItem('username', user);
            return user;
        };
    };
    function getUsername_2 () {
        if (!localStorage.hasOwnProperty('username')) {
            localStorage.setItem('username', prompt('Please enter a username'));
        }
        return localStorage.getItem('username');
    }
    socket.emit("new user", getUsername_2());
    console.log(getUsername())
    sendMsg.addEventListener("click", function () {
        const newMsg = storeMsg.contentWindow.document.createElement('p');
        newMsg.innerHTML = `${getUsername()}: ${msgBox.value}`;
        storeMsg.contentWindow.document.body.appendChild(newMsg);
        socket.emit('new message', `${getUsername()}: ${msgBox.value}<br><br>`);
        msgBox.value = ``
    });
    socket.on('new message', (data) => {
        const a = document.createElement('p');
        console.log(data)
        a.innerHTML = data.message;
        storeMsg.contentWindow.document.body.appendChild(a);
    });
    function encodeImageFileAsURL(element) {
        let file = element.files[0];
        let reader = new FileReader();
        reader.onload = function() {
            const dataUrl = reader.result
            socket.emit('new message', `${getUsername()} sent an image<br><image src="${dataUrl}"></image><br><br>`);
            window.location.reload();
        }
        reader.readAsDataURL(file);
      }
    </script>
</body>
</html>